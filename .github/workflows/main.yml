name: CI

on: [push,pull_request]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest]
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-java@v1
        with:
          java-version: '12.x'
      - uses: subosito/flutter-action@v1
        with:
          channel: 'dev'
      - run: flutter pub get
      - run: flutter format .
      - run: flutter analyze
      - run: flutter config --enable-web
      - run: flutter test

      # taken from https://medium.com/evenbit/publishing-dart-packages-with-github-actions-5240068a2f7d
#      - name: Setup credentials
#        run: |
#          mkdir -p ~/.pub-cache
#          cat <<EOF > ~/.pub-cache/credentials.json
#          {
#            "accessToken":"${{ secrets.OAUTH_ACCESS_TOKEN }}",
#            "refreshToken":"${{ secrets.OAUTH_REFRESH_TOKEN }}",
#            "tokenEndpoint":"https://accounts.google.com/o/oauth2/token",
#            "scopes": [ "openid", "https://www.googleapis.com/auth/userinfo.email" ],
#            "expiration": 1570721159347
#          }
#          EOF
#      - name: Publish package
#        run: pub publish -f

      - run: pushd example&&flutter build web
      - name: Deploy web
        uses: garygrossgarten/github-action-scp@release
        with:
          local: example/build/web
          remote: fromgithub/
          host: ${{ secrets.jodhost }}
          username: ${{ secrets.jodsshuser }}
          password: ${{ secrets.jodsshpassword }}
          recursive: true
      - run: pushd example&&flutter build apk --release
      - name: Deploy apk
        uses: garygrossgarten/github-action-scp@release
        with:
          local: example/build/app/outputs/apk/release
          remote: fromgithub/
          host: ${{ secrets.jodhost }}
          username: ${{ secrets.jodsshuser }}
          password: ${{ secrets.jodsshpassword }}
          recursive: true


# ios build fails apparently because of missing signature despite the --no-codesign parameter
#      - run: pushd example&&flutter build ios --release --no-codesign
#      - name: Deploy ios
#        uses: garygrossgarten/github-action-scp@release
#        with:
#          local: example/build/ios/iphoneos/Runner.app
#          remote: fromgithub/
#          host: ${{ secrets.jodhost }}
#          username: ${{ secrets.jodsshuser }}
#          password: ${{ secrets.jodsshpassword }}
#          recursive: true
